name: Build P4EXP Setup.exe

on:
  push:
    branches: [main]
  workflow_dispatch:

jobs:
  build:
    runs-on: windows-latest

    env:
      P4PORT: ${{ secrets.P4PORT }}
      P4USER: ${{ secrets.P4USER }}
      P4PASSWD: ${{ secrets.P4PASSWD }}

    steps:
      - name: Checkout repository
        uses: actions/checkout@v3

      - name: Setup .NET SDK
        uses: actions/setup-dotnet@v3
        with:
          dotnet-version: '7.0.x'

      - name: Apply Chinese localization
        run: |
          cp localization/zh-CN/* P4EXP/**

      - name: Build project
        run: |
          dotnet restore P4EXP.sln
          dotnet build P4EXP.sln --configuration Release

      - name: Build Setup.exe with Advanced Installer
        uses: caphyon/advinst-github-action@main
        with:
          advinst-version: '22.0'
          advinst-license: ${{ secrets.ADVINST_LICENSE_KEY }}
          advinst-enable-automation: 'true'
          aip-path: installer/P4EXP.aip
          aip-build-name: DefaultBuild
          aip-package-name: Setup.exe
          aip-output-dir: ${{ github.workspace }}/installer/output
          aip-commands: |
            SetVersion ${{ github.run_number }}.0.0

      - name: Upload Setup.exe
        uses: actions/upload-artifact@v3
        with:
          name: P4EXP-Setup
          path: installer/output/Setup.exe
